<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Law Brewing: Smart Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { border: 4px solid #d4af37; }
        #debug { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; pointer-events: none; }
    </style>
</head>
<body>
    <div id="debug">Initializing Smart Slicer...</div>
    <div id="game-container"></div>

    <script>
        const config = {
            type: Phaser.AUTO,
            width: 1024,
            height: 768,
            parent: 'game-container',
            backgroundColor: '#1b301b',
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let player, cursors;
        let debugText = document.getElementById('debug');

        // --- THE MAP BLUEPRINT ---
        const levelMap = [
            { x: 1, y: 1, type: 'road', frame: 3, angle: 90 }, // Corner
            { x: 2, y: 1, type: 'road', frame: 1, angle: 90 }, // Straight
            { x: 3, y: 1, type: 'road', frame: 1, angle: 90 }, // Straight
            { x: 4, y: 1, type: 'road', frame: 3, angle: 180 },// Corner
            { x: 4, y: 2, type: 'road', frame: 1, angle: 0 },  // Straight Down
            { x: 4, y: 3, type: 'road', frame: 3, angle: -90 },// Corner
            { x: 3, y: 3, type: 'road', frame: 1, angle: 90 }, // Straight Left
            { x: 2, y: 3, type: 'road', frame: 2, angle: 0 },  // T-Junction

            { x: 2, y: 0, type: 'building', frame: 0 }, // Town Hall
            { x: 5, y: 1, type: 'building', frame: 1 }, // Lambeau
            { x: 1, y: 3, type: 'building', frame: 2 }  // Pub
        ];

        function preload() {
            this.load.crossOrigin = 'anonymous';
            const base = 'https://lawbrewing.github.io/LawBrewing/';
            
            // LOAD AS RAW IMAGES FIRST (So we can measure them)
            this.load.image('roads_raw', base + 'roads.png');
            this.load.image('buildings_raw', base + 'buildings2.png');
            this.load.image('truck', base + 'green.png');
        }

        function create() {
            // --- STEP 1: MEASURE AND SLICE ---
            // ROADS: We know it's a 2x2 grid.
            const roadTexture = this.textures.get('roads_raw').getSourceImage();
            const rWidth = roadTexture.width;
            const rHeight = roadTexture.height;
            debugText.innerText = `Roads Detected: ${rWidth}x${rHeight}`;

            // Create the sprite sheet using exact math
            this.textures.addSpriteSheet('roads', this.textures.get('roads_raw'), {
                frameWidth: rWidth / 2,
                frameHeight: rHeight / 2
            });

            // BUILDINGS: We know it's a 1x3 row.
            const bldgTexture = this.textures.get('buildings_raw').getSourceImage();
            this.textures.addSpriteSheet('buildings', this.textures.get('buildings_raw'), {
                frameWidth: bldgTexture.width / 3,
                frameHeight: bldgTexture.height
            });

            // --- STEP 2: DRAW MAP ---
            const TILE_SIZE = 128;
            
            levelMap.forEach(tile => {
                let px = tile.x * TILE_SIZE;
                let py = tile.y * TILE_SIZE;

                if (tile.type === 'road') {
                    let r = this.add.image(px, py, 'roads', tile.frame);
                    r.setDisplaySize(TILE_SIZE, TILE_SIZE);
                    r.setAngle(tile.angle);
                } else if (tile.type === 'building') {
                    let b = this.add.image(px, py, 'buildings', tile.frame);
                    b.setDisplaySize(TILE_SIZE * 1.5, TILE_SIZE * 1.5);
                    b.setDepth(10);
                }
            });

            // --- STEP 3: PLAYER ---
            player = this.physics.add.sprite(256, 400, 'truck');
            player.setDisplaySize(80, 50);
            player.setDepth(20);
            player.setCollideWorldBounds(true);

            this.cameras.main.startFollow(player, true, 0.1, 0.1);
            this.cameras.main.setZoom(1.0);
            cursors = this.input.keyboard.createCursorKeys();
        }

        function update() {
            player.setVelocity(0);
            const speed = 300;
            if (cursors.left.isDown) { player.setVelocityX(-speed); player.setAngle(180); player.setFlipY(true); }
            else if (cursors.right.isDown) { player.setVelocityX(speed); player.setAngle(0); player.setFlipY(false); }
            else if (cursors.up.isDown) { player.setVelocityY(-speed); player.setAngle(-90); }
            else if (cursors.down.isDown) { player.setVelocityY(speed); player.setAngle(90); }
        }
    </script>
</body>
</html>
